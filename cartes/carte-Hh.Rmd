---
title: "Carte de distribution de la punaise diabolique en France"
author: ""
date: ""
output:
  github_document
    # always_allow_html: yes
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

La carte indique les signalements valides reçus sur l'application <a href="https://rossi-jp.github.io/crises/agiir.html" target="_blank">AGIIR</a> entre 2014 et décembre 2019. Cliquez sur les icônes pour visualiser des informations complémentaires.

<!-- OK mais lourd -->
```{r, eval=T, echo=F, results=T, warning=F, error=F, message=F, strip.white=T, include=T}
rm(list=ls()) ; set.seed(1967)
library(leaflet) ; library(leaflet.extras) ; library(leaflet.extras2) ; library(raster) ; library(sf)
# lecture et gestion d'un shapefile
departements <- st_read("/Users/rossi/Documents/sauvegarde/RdocsJP/github_sites_web_en_rmarkdown/crises/agiir/carto/ne_10m_admin_1_states_provinces/ne_10m_admin_1_states_provinces.shp", quiet=T)
# découper la France
wf <- which(departements$admin=="France")
departements <- departements[wf,]
wf <- which(departements$type=="Metropolitan département") # on ne garde que les dpt métropolitains
departements <- departements[wf,]
#
##--- Données occ
data <- read.csv("/Users/rossi/Documents/sauvegarde/RdocsJP/github_sites_web_en_rmarkdown/crises/cartes/Hh/oo_522847.csv", sep="\t")
#names(data)
#sort(unique(data$scientific_name))

##--- retire les points sans date
w <- which(is.na(data$date)==T)
data <- data[-w,]
#
##--- création d'une colonne séparant signalements valides et invalides
w <- which(data$scientific_name=="Halyomorpha halys") #; length(w)
data$diagnostic <- "Autres" ; data$diagnostic[w] <- "Halyomorpha halys"

##--- création d'une colonne annee
##--- ATTENTION il faut des character sinon pb plus bas dans attribution aux groupes...
data$annee <- substr(x=data$date,start=1,stop=4)
#
##--- certaines coordonnées posent problème
#any(is.na(data$latitude))

w <- which(is.na(data$latitude)==T)
data <- data[-w,]

#--- retire les annees NA
#w <- which(is.na(data$annee)==T)
#data <- data[-w,]

# names(data)
# #  [1] "id"                      "latitude"                "longitude"               "scientific_name"         "additional_species"
# #  [6] "date"                    "verbatim_environment"    "environment"             "identification_support"  "issues"
# # [11] "initial_duplicated_form" "source"                  "media"                   "note"                    "diagnostic"
# # [16] "annee"
##sort(unique(data$annee))
##--- recode en français
#unique(data$environment) # "garden"     "habitation" "crop"       NA           "urban"
data$environment2 <- data$environment
data$environment[data$environment=="garden"] <- "Jardin"
data$environment[data$environment=="habitation"] <- "Habitation"
data$environment[data$environment=="crop"] <- "Culture"
data$environment[data$environment=="urban"] <- "Environnement urbain"
data$environment[is.na(data$environment)] <- "Environnement non communiqué"


##--- ici on filtre pour retirer les points associés à des coordonnée (fausses) trop éloignées de la France
w <- which(data$longitude < -10 | data$longitude > 15)
data <- data[-w,]
w <- which(data$latitude < 36 | data$latitude > 53)
data <- data[-w,]

temp <- data.frame(lon=data$longitude, lat=data$latitude, scientific_name=data$scientific_name, annee=data$annee, diagnostic=data$diagnostic, date=data$date, environment=data$environment)
w <- which(temp$scientific_name=="Halyomorpha halys") #; length(w)
temp1 <- temp[w,]
temp0 <- temp[-w,]
#names(temp0)
#
##--- traduction des points invalides sous la forme de s-f points pour ne pas ralentir l'affichage en tant que points OSM
temp0.sf <- st_as_sf(temp0, coords = c("lon","lat"), remove = FALSE)
##plot(st_geometry(temp0.sf))


##--- configuration icônes
icon0 <- makeAwesomeIcon(icon = "user", library = "glyphicon", markerColor = "blue", iconColor="black")
icon1 <- makeAwesomeIcon(icon = "user", library = "glyphicon", markerColor = "red", iconColor="black")
lab1 <- paste(sep="", data$date, "\n", "environnement : ", data$environment)
# 
##--- configuration raster
opacity1 <- 0.75 ; opacity2 <- 0.5
#pal <- colorNumeric("Spectral", pred.fr[], na.color="#00000000")
col1 <- "white" ; col2 <- "blue"
colv <- c(col1, col2)
# 
##--- paquets de points par année
groupes.liste <- vector(mode="list", length=length(unique(temp1$annee)))
for(i in 1:(length(groupes.liste))){
  #cat("groupe : ", unique(data$lab1)[i], "\n")
  w <- which(temp1$annee==unique(temp1$annee)[i])
  groupes.liste[[i]] <- temp1[w,]
}
# 
map <- leaflet(width=900, height=700)
##--- Ajoute 2 couches OSM
map <- addTiles(map=map, group = "OSM (default)")
map <- setView(map=map, lng = 2.5, lat=46.85, zoom=6)
#map <- addProviderTiles(map=map, providers$OpenTopoMap, group = "Topography")
# 
# ##--- Ajoute les départements
# map <- map %>% addPolygons(data=departements, color = "#444444", fillOpacity = 0.0, group="départements", label = departements$name_fr, weight=1.50)
# 
# # ##--- Ajoute les prédictions du modèle
# # # na.color="#00000000" permet d'avoir les NA du raster en transparent
# # map <- map %>% addRasterImage(x=pred.fr, colors = pal, opacity = opacity1, group="Adéquation climatique")
# 
map <- addAwesomeMarkers(map=map, lng = temp1$lon, lat = temp1$lat, label=temp1$annee, icon=icon1, popup=lab1)
# # 
map


# # ##--- première série de points : les valides
# # for(i in 1:(length(groupes.liste))){
# #   #cat("groupe : ", unique(temp1$annee)[i], "\n")
# #   dtemp <- groupes.liste[[i]]
# #   map <- addAwesomeMarkers(map=map, lng = dtemp$lon, lat = dtemp$lat, label=dtemp$annee, icon=icon1, popup=lab1)
# # }
# 
# # ##--- Légende
# # # # # ajoute les labels des overlay groups (ie les points)
# # # # collapsed = T => les légendes apparaissent ensemble sous l'icone d'un stack
# # # # collapsed = F => les légendes sont toutes visibles par défaut
# # map <- map %>% addLayersControl(
# #     baseGroups = c("Topography","OpenStreetMap"),
# #     overlayGroups = c("départements", "Adéquation climatique"),
# #     options = layersControlOptions(collapsed = F, autoZIndex = T))
# # # par défaut, n'affiche pas les rasters
# # map <- map %>% hideGroup("Invalides") %>% hideGroup("Adéquation climatique")
# # # ajout d'un titre
# # map <- oceanis::add_titre(map, titre="Signalements valides", sousTitre = "")
# # map
# # 
# 
# 
# #
```

Jean-Claude Streito, Marguerite Chartois & Jean-Pierre Rossi

## Références bibliographiques

- Chartois, M., Streito, J.-C., Pierre, É., Armand, J.-M., Gaudin, J., Rossi, J.-P., 2021. A crowdsourcing approach to track the expansion of the brown marmorated stinkbug *Halyomorpha halys* (Stål, 1855) in France. BDJ 9, e66335. https://doi.org/10.3897/BDJ.9.e66335

- Streito, J.-C., Chartois, M., Pierre, É., Dusoulier, F., Armand, J.-M., Gaudin, J., Rossi, J.-P., 2021. Citizen science and niche modeling to track and forecast the expansion of the brown marmorated stinkbug *Halyomorpha halys* (Stål, 1855). Scientific Reports 11, 11421. https://doi.org/10.1038/s41598-021-90378-1
